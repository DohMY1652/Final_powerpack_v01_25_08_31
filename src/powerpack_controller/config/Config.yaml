# [MODIFIED] Added 'pp_controller:' as the top-level key and indented all content.
pp_controller:
  ros__parameters:
    active_mpc_channels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    sensor_filter_alpha: 0.01


    # === per-channel calibration (map-based) ===
    Sensor_calibration:
      atm_offset: 101.325
      b0:
        "0": { offset: 1002.0,  gain: 0.250 }
        "1": { offset: 995.0,  gain: 0.250 }
        "2": { offset: 1002.0,  gain: 0.250 }
        "3": { offset: 1015.0,  gain: 0.250 }
      b1:
        "0": { offset: 980.0,  gain: 0.250 }
        "1": { offset: 1001.0,  gain: 0.250 }
        "2": { offset: 960.0,  gain: -0.02525 }
        "3": { offset: 955.0,  gain: -0.02525 }
      b2:
        "0": { offset: 940.0,  gain: -0.02525 }
        "1": { offset: 956.0,  gain: -0.02525 }
        "2": { offset: 970.0,  gain: -0.02525 }
        "3": { offset: 965.0,  gain: -0.02525 }
        "4": { offset: 668.0,  gain: 0.3150 }   # pos line (핀20)
        "5": { offset: 657.0,  gain: -0.0378 }  # neg line (핀21)
        "6": { offset: 442.0,  gain: 0.6800 }   # macro line (핀22)

    RefTcp:
      enable: true
      bind_address: "0.0.0.0"
      port: 15000
      expect_n: 12
      scale: 0.01

    LinePID:
      pos:
        kp: 4.0
        ki: 1.0
        kd: 0.0
        ref: 400.0
        pwm_index: 12
      # 주의: 현재 코드엔 neg PID 사용 안 함(무시됨)

      # [추가됨] 음압 라인 PID 설정
      neg:
        kp: 0.8      # 예시값, 실제 시스템에 맞게 튜닝 필요
        ki: 0.2      # 예시값, 실제 시스템에 맞게 튜닝 필요
        kd: 0.0      # 예시값, 실제 시스템에 맞게 튜닝 필요
        ref: 40.0      # 목표 음압(절대압 기준), 예시값
        pwm_index: 13  # 보드2의 14번째 PWM 채널
      out_min: 0.0
      out_max: 100.0

    Reference_parameters:
      frequency: 1000

    PWM_parameters:
      frequency: 1000
      pid_pos_index: 18
      pid_neg_index: 19

    MPC_parameters:
      NP: 5
      n_x: 1
      n_u: 3
      Ts: 0.004
      Q_values: 20.0
      R_values: 0.1
      pos_ku_micro: 1.5
      pos_ku_macro: 0.5
      pos_ku_atm: 3.0
      neg_ku_micro: 3.0
      neg_ku_macro: 0.1
      neg_ku_atm: 6.0

      # --- 새로 추가할 I 게인 (ki) ---
  # 처음에는 작은 값으로 시작하여 튜닝하는 것을 권장합니다.
      pos_ki_micro: 0.8
      pos_ki_macro: 0.2
      pos_ki_atm: 0.5
      neg_ki_micro: 2.0
      neg_ki_macro: 0.1
      neg_ki_atm: 2.0
      
      # [추가됨] Macro 밸브 사용량을 줄이기 위한 게인 승수 (0.0 ~ 1.0 사이 값 권장)
      macro_gain_multiplier: 1.0

    channel_volume:
      ch0_ml: 100
      ch1_ml: 100
      ch2_ml: 100
      ch3_ml: 100
      ch4_ml: 100
      ch5_ml: 100
      
      ch6_ml: 100
      ch7_ml: 100
      ch8_ml: 100
      ch9_ml: 100
      ch10_ml: 100
      ch11_ml: 100

    system_parameters:
      sensor_print: false
      reference_print: false
      pwm_print: false
      valve_operate: true

    MacroSwitch:
      threshold_kpa: 600.0