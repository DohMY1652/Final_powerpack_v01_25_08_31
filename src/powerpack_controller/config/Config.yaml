# [MODIFIED] Added 'pp_controller:' as the top-level key and indented all content.
pp_controller:
  ros__parameters:
    log_channel_id: 2
    active_mpc_channels: [0,1,2,3,4,5,6,7,8,9,10,11]

    # === per-channel calibration (map-based) ===
    Sensor_calibration:
      atm_offset: 101.325
      b0:
        "0": { offset: 868.0,  gain: 0.3042 }
        "1": { offset: 856.0,  gain: 0.3042 }
        "2": { offset: 865.0,  gain: 0.3042 }
        "3": { offset: 857.0,  gain: 0.3042 }
      b1:
        "0": { offset: 832.0,  gain: 0.3042 }
        "1": { offset: 856.0,  gain: 0.3042 }
        "2": { offset: 448.0,  gain: -0.0604925 }
        "3": { offset: 458.0,  gain: -0.0604925 }
      b2:
        "0": { offset: 435.0,  gain: -0.0604925 }
        "1": { offset: 433.0,  gain: -0.0604925 }
        "2": { offset: 434.0,  gain: -0.0604925 }
        "3": { offset: 434.0,  gain: -0.0604925 }
        "4": { offset: 829.0,  gain: 0.3066 }   # pos line (핀20)
        "5": { offset: 817.0,  gain: -0.0309577 }  # neg line (핀21)
        "6": { offset: 487.0,  gain: 0.640 }   # macro line (핀22)

    RefTcp:
      enable: true
      bind_address: "0.0.0.0"
      port: 15000
      expect_n: 12
      scale: 0.01

    LinePID:
      pos:
        kp: 0.4
        ki: 0.1
        kd: 0.0
        ref: 400.0
        pwm_index: 12
      # 주의: 현재 코드엔 neg PID 사용 안 함(무시됨)

      # [추가됨] 음압 라인 PID 설정
      neg:
        kp: 0.8      # 예시값, 실제 시스템에 맞게 튜닝 필요
        ki: 0.2      # 예시값, 실제 시스템에 맞게 튜닝 필요
        kd: 0.0      # 예시값, 실제 시스템에 맞게 튜닝 필요
        ref: 40.0      # 목표 음압(절대압 기준), 예시값
        pwm_index: 13  # 보드2의 14번째 PWM 채널
      out_min: 0.0
      out_max: 100.0

    Reference_parameters:
      frequency: 1000

    PWM_parameters:
      frequency: 1000
      pid_pos_index: 18
      pid_neg_index: 19

    MPC_parameters:
      NP: 5
      n_x: 1
      n_u: 3
      Ts: 0.01
      Q_values: 20.0
      R_values: 1.0
      pos_ku_micro: 0.5
      pos_ku_macro: 0.5
      pos_ku_atm: 0.5
      neg_ku_micro: 3.0
      neg_ku_macro: 3.0
      neg_ku_atm: 6.0

      # --- 새로 추가할 I 게인 (ki) ---
  # 처음에는 작은 값으로 시작하여 튜닝하는 것을 권장합니다.
      pos_ki_micro: 1.0
      pos_ki_macro: 1.0
      pos_ki_atm: 1.0
      neg_ki_micro: 0.15
      neg_ki_macro: 0.15
      neg_ki_atm: 0.3

    channel_volume:
      pos1: 100
      pos2: 100
      pos3: 100
      pos4: 100
      pos5: 100
      pos6: 100
      neg1: 100
      neg2: 100
      neg3: 100
      neg4: 100
      neg5: 100
      neg6: 100

    system_parameters:
      sensor_print: true
      reference_print: true
      pwm_print: true
      valve_operate: false

    MacroSwitch:
      threshold_kpa: 600.0